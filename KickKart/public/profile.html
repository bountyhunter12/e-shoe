<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/f2e87d7666.js" crossorigin="anonymous"></script>
  <title>E-Commerce</title>
  <link rel="stylesheet" href="style2.css">
  <link rel="stylesheet" href="men1.css">
</head>

<body>
  <div class="top">
    <img class="bg-img" style="height: 200px;" src="img/pro.jpg" alt="">
    <section id="header">
      <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
          <a class="navbar-brand" style="padding-left: 40px;" href="#">
            <h3>KickKart</h3>
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" aria-current="page" href="index.html">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="women.html">Women</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="men.html">Men</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#"><i class="fa-solid fa-cart-shopping" id="cart-icon"
                    data-quantity="0"></i></a>
              </li>
              <li class="nav-item">
                <div id="user-email"></div>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="profile.html"><i class="fa-solid fa-user"></i></a>
              </li>
              <li class="nav-item">
                <div class="btn-field">
                  <button type="button" id="logout">Log Out</button>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </section>
    <div class="cart1" style="overflow-y: auto;">
      <h2 class="cart-title">Your Cart</h2>
      <div class="cart-content">
        <!-- Cart items will be added here dynamically -->
      </div>
      <div class="total">
        <div class="total-title">Total</div>
        <div class="total-price">$0</div>
      </div>
      <a style="text-decoration: none;" href="#">
        <button type="button" style="margin-left: 200px;" class="btn btn-light btn-outline-dark btn-buy">Pay
          Now</button>
      </a>
      <i class="fa-solid fa-circle-xmark" id="close-cart"></i>
    </div>
  </div>
</div>
<div class="prof">
  <h4><span id="user-name"></span></h4>
  <h7><span style="font-size: 13px;" id="mail"></span></h7>
  <p style=" font-size: 46px; color: #222; margin-top: -60px;">Purchasing History</p>
  <div class="ta" style="margin-left: 200px; margin-top: 10px;">
    <table class="table table-dark table-hover">
      <thead>
        <tr>
          <th scope="col">Product Name</th>
          <th scope="col">Price</th>
          <th scope="col">Quantity</th>
          <th scope="col">Image</th>
          <th scope="col">Date Bought</th>
        </tr>
      </thead>
      <tbody id="order-table-body">
        <!-- Orders will be dynamically populated here -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4"><strong>Total Price</strong></td>
          <td id="total-price"></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="footer-col">
        <h4>KickKart</h4>
        <ul>
          <li><a href="new.html">New Arrivals</a></li>
          <li><a href="index.html">Featured Products</a></li>
          <li><a href="#">privacy policy</a></li>
          <li><a href="#">affiliate program</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>get help</h4>
        <ul>
          <li><a href="#">FAQ</a></li>
          <li><a href="#">shipping</a></li>
          <li><a href="#">returns</a></li>
          <li><a href="payment.html">order status</a></li>
          <li><a href="payment.html">payment options</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>online shop</h4>
        <ul>
          <li><a href="men.html">Men</a></li>
          <li><a href="women.html">Women</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>follow us</h4>
        <div class="social-links">
          <a href="#"><i class="fab fa-facebook"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-linkedin"></i></a>
        </div>
      </div>
    </div>
  </div>
</footer>
<script src="cart1.js"></script>
<script>
  window.onload = async function () {
  await checkUserLoginStatus(); // This should run first to check if the user is logged in
  fetchUserName(); // This will fetch and display the user name and email
  fetchOrders(); // This will fetch and display the orders
};

async function checkUserLoginStatus() {
  try {
    const response = await fetch('/getUser', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include', // Include credentials (cookies) with the request
    });

    if (response.ok) {
      const user = await response.json();
      if (!user || !user.email) {
        console.log('no token');
        window.location.href = '/login.html'; // Redirect to login page if no user is found
      } else {
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('mail').textContent = user.email;
      }
    } else {
      window.location.href = '/login.html'; // Redirect to login page if the request fails
    }
  } catch (error) {
    console.error('Error checking user login status:', error);
    window.location.href = '/login.html'; // Redirect to login page in case of error
  }
}

async function fetchUserName() {
  try {
    const response = await fetch('/getUser');
    if (response.ok) {
      const user = await response.json();
      document.getElementById('user-name').textContent = user.name;
      document.getElementById('mail').textContent = user.email;
    } else {
      console.error('Failed to fetch user:', response.status);
    }
  } catch (error) {
    console.error('Error fetching user:', error);
  }
}

async function fetchOrders() {
  try {
    const response = await fetch('/api/orders', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include' // Include credentials (cookies) with the request
    });

    if (response.ok) {
      const orders = await response.json();
      displayOrders(orders);
    } else {
      console.error('Failed to fetch orders:', response.status);
    }
  } catch (error) {
    console.error('Error fetching orders:', error);
  }
}

function displayOrders(orders) {
  const tbody = document.getElementById('order-table-body');
  const totalPriceElement = document.getElementById('total-price');
  let totalPrice = 0;

  orders.forEach(order => {
    order.products.forEach(product => {
      const row = document.createElement('tr');

      const productNameCell = document.createElement('td');
      productNameCell.textContent = product.productName;
      row.appendChild(productNameCell);

      const priceCell = document.createElement('td');
      priceCell.textContent = `$${product.price.toFixed(2)}`;
      row.appendChild(priceCell);

      const quantityCell = document.createElement('td');
      quantityCell.textContent = product.quantity;
      row.appendChild(quantityCell);

      const imageCell = document.createElement('td');
      const img = document.createElement('img');
      img.src = product.productImg;
      img.style.width = '50px';
      img.style.height = '50px';
      imageCell.appendChild(img);
      row.appendChild(imageCell);

      const dateCell = document.createElement('td');
      const dateBought = new Date(order.dateBought);
      dateCell.textContent = dateBought.toLocaleDateString();
      row.appendChild(dateCell);

      tbody.appendChild(row);

      // Calculate the total price
      totalPrice += product.price * product.quantity;
    });
  });
  document.getElementById('logout').addEventListener('click', () => {
  fetch('/logout', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'include' // Include credentials (cookies) with the request
  })
  .then(response => {
    if (response.ok) {
      localStorage.removeItem('usernameToken'); // Clear the token from localStorage
      window.location.href = '/index.html'; // Redirect to homepage or login page
    } else {
      alert('Logout failed');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Logout failed');
  });
});



  // Display the total price in the table footer
  totalPriceElement.textContent = `$${totalPrice.toFixed(2)}`;
}

</script>

</body>
</html>